#!/bin/bash

# Change dir to the original one at the exit
trap "cd $PWD" EXIT

# Change dir to script's
{
    src="${BASH_SOURCE[0]}"
    while [[ -L ${src} ]]; do
        # shellcheck disable=SC1117
        src=$(find "${src}" -type l -ls | sed -n 's/^.* -> \(.*\)/\1/p')
    done
    dir=$(cd -P "$(dirname "${src}")" && pwd)
    cd $dir || exit 1
}

source functions || die "Failed to source functions."

assert_cmd_exist "stow"
setup_build_dir

# Download files
{
    while IFS= read -r line; do
        manifest_download $line
    done <MANIFEST && echo "--"
}

find build/ -type f -name ".DS_Store" -delete

# .sys.in setup
{
    sys_set OS $(uname)

    cmd_exist "trash" && sys_set "TRASH_CMD" "trash" ||
        cmd_exist "rmtrash" && sys_set "TRASH_CMD" "rmtrash" ||
        sys_set "TRASH_CMD" ""

    cmd_exist fzf && sys_set HAS_FZF 1 || sys_set HAS_FZF 0
    cmd_exist mcfly && sys_set HAS_MCFLY 1 || sys_set HAS_MCFLY 0

    /bin/mv build/home/.sys.in home/.sys
    /bin/rm build/home/.sys.in.bak
}

(
    cd build
    stow -v --target $HOME -D home && echo "--" || die "Stow failed."
    stow -v --target $HOME home && echo "--" || die "Stow failed."
)
