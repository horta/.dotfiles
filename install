#!/bin/bash

# Change to original directory at the end
trap "cd $PWD" EXIT

# Change to script directory
function cd_root_dir
{
    local source="${BASH_SOURCE[0]}"
    while [[ -L ${source} ]]; do
        # shellcheck disable=SC1117
        source=$(find "${source}" -type l -ls | sed -n 's/^.* -> \(.*\)/\1/p')
    done
    local dir=$(cd -P "$(dirname "${source}")" && pwd)
    cd $dir || exit 1
}
cd_root_dir

source functions || die "Failed to source functions."

assert_cmd_exist stow
setup_build_dir

while IFS= read -r line; do
    manifest_download $line
done <MANIFEST && echo "--"

cd build
find . -type f -name ".DS_Store" -delete

sed -e "s/{OS}/$(uname)/" -i.bak home/.sys.in
cmd_exist trash && sed -e "s/{TRASH_CMD}/trash/" -i.bak home/.sys.in
cmd_exist rmtrash && sed -e "s/{TRASH_CMD}/rmthrash/" -i.bak home/.sys.in
sed -e "s/{TRASH_CMD}//" -i.bak home/.sys.in
/bin/mv home/.sys.in home/.sys
/bin/rm home/.sys.in.bak

stow -v --target $HOME -D home && echo "--" || die "Stow failed."
stow -v --target $HOME home && echo "--" || die "Stow failed."
